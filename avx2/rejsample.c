#include <stdint.h>
#include <immintrin.h>
#include "params.h"
#include "rejsample.h"

static const unsigned char idx[256][8] = {
  { 0,  0,  0,  0,  0,  0,  0,  0},
  { 0,  0,  0,  0,  0,  0,  0,  0},
  { 2,  0,  0,  0,  0,  0,  0,  0},
  { 0,  2,  0,  0,  0,  0,  0,  0},
  { 4,  0,  0,  0,  0,  0,  0,  0},
  { 0,  4,  0,  0,  0,  0,  0,  0},
  { 2,  4,  0,  0,  0,  0,  0,  0},
  { 0,  2,  4,  0,  0,  0,  0,  0},
  { 6,  0,  0,  0,  0,  0,  0,  0},
  { 0,  6,  0,  0,  0,  0,  0,  0},
  { 2,  6,  0,  0,  0,  0,  0,  0},
  { 0,  2,  6,  0,  0,  0,  0,  0},
  { 4,  6,  0,  0,  0,  0,  0,  0},
  { 0,  4,  6,  0,  0,  0,  0,  0},
  { 2,  4,  6,  0,  0,  0,  0,  0},
  { 0,  2,  4,  6,  0,  0,  0,  0},
  { 8,  0,  0,  0,  0,  0,  0,  0},
  { 0,  8,  0,  0,  0,  0,  0,  0},
  { 2,  8,  0,  0,  0,  0,  0,  0},
  { 0,  2,  8,  0,  0,  0,  0,  0},
  { 4,  8,  0,  0,  0,  0,  0,  0},
  { 0,  4,  8,  0,  0,  0,  0,  0},
  { 2,  4,  8,  0,  0,  0,  0,  0},
  { 0,  2,  4,  8,  0,  0,  0,  0},
  { 6,  8,  0,  0,  0,  0,  0,  0},
  { 0,  6,  8,  0,  0,  0,  0,  0},
  { 2,  6,  8,  0,  0,  0,  0,  0},
  { 0,  2,  6,  8,  0,  0,  0,  0},
  { 4,  6,  8,  0,  0,  0,  0,  0},
  { 0,  4,  6,  8,  0,  0,  0,  0},
  { 2,  4,  6,  8,  0,  0,  0,  0},
  { 0,  2,  4,  6,  8,  0,  0,  0},
  {10,  0,  0,  0,  0,  0,  0,  0},
  { 0, 10,  0,  0,  0,  0,  0,  0},
  { 2, 10,  0,  0,  0,  0,  0,  0},
  { 0,  2, 10,  0,  0,  0,  0,  0},
  { 4, 10,  0,  0,  0,  0,  0,  0},
  { 0,  4, 10,  0,  0,  0,  0,  0},
  { 2,  4, 10,  0,  0,  0,  0,  0},
  { 0,  2,  4, 10,  0,  0,  0,  0},
  { 6, 10,  0,  0,  0,  0,  0,  0},
  { 0,  6, 10,  0,  0,  0,  0,  0},
  { 2,  6, 10,  0,  0,  0,  0,  0},
  { 0,  2,  6, 10,  0,  0,  0,  0},
  { 4,  6, 10,  0,  0,  0,  0,  0},
  { 0,  4,  6, 10,  0,  0,  0,  0},
  { 2,  4,  6, 10,  0,  0,  0,  0},
  { 0,  2,  4,  6, 10,  0,  0,  0},
  { 8, 10,  0,  0,  0,  0,  0,  0},
  { 0,  8, 10,  0,  0,  0,  0,  0},
  { 2,  8, 10,  0,  0,  0,  0,  0},
  { 0,  2,  8, 10,  0,  0,  0,  0},
  { 4,  8, 10,  0,  0,  0,  0,  0},
  { 0,  4,  8, 10,  0,  0,  0,  0},
  { 2,  4,  8, 10,  0,  0,  0,  0},
  { 0,  2,  4,  8, 10,  0,  0,  0},
  { 6,  8, 10,  0,  0,  0,  0,  0},
  { 0,  6,  8, 10,  0,  0,  0,  0},
  { 2,  6,  8, 10,  0,  0,  0,  0},
  { 0,  2,  6,  8, 10,  0,  0,  0},
  { 4,  6,  8, 10,  0,  0,  0,  0},
  { 0,  4,  6,  8, 10,  0,  0,  0},
  { 2,  4,  6,  8, 10,  0,  0,  0},
  { 0,  2,  4,  6,  8, 10,  0,  0},
  {12,  0,  0,  0,  0,  0,  0,  0},
  { 0, 12,  0,  0,  0,  0,  0,  0},
  { 2, 12,  0,  0,  0,  0,  0,  0},
  { 0,  2, 12,  0,  0,  0,  0,  0},
  { 4, 12,  0,  0,  0,  0,  0,  0},
  { 0,  4, 12,  0,  0,  0,  0,  0},
  { 2,  4, 12,  0,  0,  0,  0,  0},
  { 0,  2,  4, 12,  0,  0,  0,  0},
  { 6, 12,  0,  0,  0,  0,  0,  0},
  { 0,  6, 12,  0,  0,  0,  0,  0},
  { 2,  6, 12,  0,  0,  0,  0,  0},
  { 0,  2,  6, 12,  0,  0,  0,  0},
  { 4,  6, 12,  0,  0,  0,  0,  0},
  { 0,  4,  6, 12,  0,  0,  0,  0},
  { 2,  4,  6, 12,  0,  0,  0,  0},
  { 0,  2,  4,  6, 12,  0,  0,  0},
  { 8, 12,  0,  0,  0,  0,  0,  0},
  { 0,  8, 12,  0,  0,  0,  0,  0},
  { 2,  8, 12,  0,  0,  0,  0,  0},
  { 0,  2,  8, 12,  0,  0,  0,  0},
  { 4,  8, 12,  0,  0,  0,  0,  0},
  { 0,  4,  8, 12,  0,  0,  0,  0},
  { 2,  4,  8, 12,  0,  0,  0,  0},
  { 0,  2,  4,  8, 12,  0,  0,  0},
  { 6,  8, 12,  0,  0,  0,  0,  0},
  { 0,  6,  8, 12,  0,  0,  0,  0},
  { 2,  6,  8, 12,  0,  0,  0,  0},
  { 0,  2,  6,  8, 12,  0,  0,  0},
  { 4,  6,  8, 12,  0,  0,  0,  0},
  { 0,  4,  6,  8, 12,  0,  0,  0},
  { 2,  4,  6,  8, 12,  0,  0,  0},
  { 0,  2,  4,  6,  8, 12,  0,  0},
  {10, 12,  0,  0,  0,  0,  0,  0},
  { 0, 10, 12,  0,  0,  0,  0,  0},
  { 2, 10, 12,  0,  0,  0,  0,  0},
  { 0,  2, 10, 12,  0,  0,  0,  0},
  { 4, 10, 12,  0,  0,  0,  0,  0},
  { 0,  4, 10, 12,  0,  0,  0,  0},
  { 2,  4, 10, 12,  0,  0,  0,  0},
  { 0,  2,  4, 10, 12,  0,  0,  0},
  { 6, 10, 12,  0,  0,  0,  0,  0},
  { 0,  6, 10, 12,  0,  0,  0,  0},
  { 2,  6, 10, 12,  0,  0,  0,  0},
  { 0,  2,  6, 10, 12,  0,  0,  0},
  { 4,  6, 10, 12,  0,  0,  0,  0},
  { 0,  4,  6, 10, 12,  0,  0,  0},
  { 2,  4,  6, 10, 12,  0,  0,  0},
  { 0,  2,  4,  6, 10, 12,  0,  0},
  { 8, 10, 12,  0,  0,  0,  0,  0},
  { 0,  8, 10, 12,  0,  0,  0,  0},
  { 2,  8, 10, 12,  0,  0,  0,  0},
  { 0,  2,  8, 10, 12,  0,  0,  0},
  { 4,  8, 10, 12,  0,  0,  0,  0},
  { 0,  4,  8, 10, 12,  0,  0,  0},
  { 2,  4,  8, 10, 12,  0,  0,  0},
  { 0,  2,  4,  8, 10, 12,  0,  0},
  { 6,  8, 10, 12,  0,  0,  0,  0},
  { 0,  6,  8, 10, 12,  0,  0,  0},
  { 2,  6,  8, 10, 12,  0,  0,  0},
  { 0,  2,  6,  8, 10, 12,  0,  0},
  { 4,  6,  8, 10, 12,  0,  0,  0},
  { 0,  4,  6,  8, 10, 12,  0,  0},
  { 2,  4,  6,  8, 10, 12,  0,  0},
  { 0,  2,  4,  6,  8, 10, 12,  0},
  {14,  0,  0,  0,  0,  0,  0,  0},
  { 0, 14,  0,  0,  0,  0,  0,  0},
  { 2, 14,  0,  0,  0,  0,  0,  0},
  { 0,  2, 14,  0,  0,  0,  0,  0},
  { 4, 14,  0,  0,  0,  0,  0,  0},
  { 0,  4, 14,  0,  0,  0,  0,  0},
  { 2,  4, 14,  0,  0,  0,  0,  0},
  { 0,  2,  4, 14,  0,  0,  0,  0},
  { 6, 14,  0,  0,  0,  0,  0,  0},
  { 0,  6, 14,  0,  0,  0,  0,  0},
  { 2,  6, 14,  0,  0,  0,  0,  0},
  { 0,  2,  6, 14,  0,  0,  0,  0},
  { 4,  6, 14,  0,  0,  0,  0,  0},
  { 0,  4,  6, 14,  0,  0,  0,  0},
  { 2,  4,  6, 14,  0,  0,  0,  0},
  { 0,  2,  4,  6, 14,  0,  0,  0},
  { 8, 14,  0,  0,  0,  0,  0,  0},
  { 0,  8, 14,  0,  0,  0,  0,  0},
  { 2,  8, 14,  0,  0,  0,  0,  0},
  { 0,  2,  8, 14,  0,  0,  0,  0},
  { 4,  8, 14,  0,  0,  0,  0,  0},
  { 0,  4,  8, 14,  0,  0,  0,  0},
  { 2,  4,  8, 14,  0,  0,  0,  0},
  { 0,  2,  4,  8, 14,  0,  0,  0},
  { 6,  8, 14,  0,  0,  0,  0,  0},
  { 0,  6,  8, 14,  0,  0,  0,  0},
  { 2,  6,  8, 14,  0,  0,  0,  0},
  { 0,  2,  6,  8, 14,  0,  0,  0},
  { 4,  6,  8, 14,  0,  0,  0,  0},
  { 0,  4,  6,  8, 14,  0,  0,  0},
  { 2,  4,  6,  8, 14,  0,  0,  0},
  { 0,  2,  4,  6,  8, 14,  0,  0},
  {10, 14,  0,  0,  0,  0,  0,  0},
  { 0, 10, 14,  0,  0,  0,  0,  0},
  { 2, 10, 14,  0,  0,  0,  0,  0},
  { 0,  2, 10, 14,  0,  0,  0,  0},
  { 4, 10, 14,  0,  0,  0,  0,  0},
  { 0,  4, 10, 14,  0,  0,  0,  0},
  { 2,  4, 10, 14,  0,  0,  0,  0},
  { 0,  2,  4, 10, 14,  0,  0,  0},
  { 6, 10, 14,  0,  0,  0,  0,  0},
  { 0,  6, 10, 14,  0,  0,  0,  0},
  { 2,  6, 10, 14,  0,  0,  0,  0},
  { 0,  2,  6, 10, 14,  0,  0,  0},
  { 4,  6, 10, 14,  0,  0,  0,  0},
  { 0,  4,  6, 10, 14,  0,  0,  0},
  { 2,  4,  6, 10, 14,  0,  0,  0},
  { 0,  2,  4,  6, 10, 14,  0,  0},
  { 8, 10, 14,  0,  0,  0,  0,  0},
  { 0,  8, 10, 14,  0,  0,  0,  0},
  { 2,  8, 10, 14,  0,  0,  0,  0},
  { 0,  2,  8, 10, 14,  0,  0,  0},
  { 4,  8, 10, 14,  0,  0,  0,  0},
  { 0,  4,  8, 10, 14,  0,  0,  0},
  { 2,  4,  8, 10, 14,  0,  0,  0},
  { 0,  2,  4,  8, 10, 14,  0,  0},
  { 6,  8, 10, 14,  0,  0,  0,  0},
  { 0,  6,  8, 10, 14,  0,  0,  0},
  { 2,  6,  8, 10, 14,  0,  0,  0},
  { 0,  2,  6,  8, 10, 14,  0,  0},
  { 4,  6,  8, 10, 14,  0,  0,  0},
  { 0,  4,  6,  8, 10, 14,  0,  0},
  { 2,  4,  6,  8, 10, 14,  0,  0},
  { 0,  2,  4,  6,  8, 10, 14,  0},
  {12, 14,  0,  0,  0,  0,  0,  0},
  { 0, 12, 14,  0,  0,  0,  0,  0},
  { 2, 12, 14,  0,  0,  0,  0,  0},
  { 0,  2, 12, 14,  0,  0,  0,  0},
  { 4, 12, 14,  0,  0,  0,  0,  0},
  { 0,  4, 12, 14,  0,  0,  0,  0},
  { 2,  4, 12, 14,  0,  0,  0,  0},
  { 0,  2,  4, 12, 14,  0,  0,  0},
  { 6, 12, 14,  0,  0,  0,  0,  0},
  { 0,  6, 12, 14,  0,  0,  0,  0},
  { 2,  6, 12, 14,  0,  0,  0,  0},
  { 0,  2,  6, 12, 14,  0,  0,  0},
  { 4,  6, 12, 14,  0,  0,  0,  0},
  { 0,  4,  6, 12, 14,  0,  0,  0},
  { 2,  4,  6, 12, 14,  0,  0,  0},
  { 0,  2,  4,  6, 12, 14,  0,  0},
  { 8, 12, 14,  0,  0,  0,  0,  0},
  { 0,  8, 12, 14,  0,  0,  0,  0},
  { 2,  8, 12, 14,  0,  0,  0,  0},
  { 0,  2,  8, 12, 14,  0,  0,  0},
  { 4,  8, 12, 14,  0,  0,  0,  0},
  { 0,  4,  8, 12, 14,  0,  0,  0},
  { 2,  4,  8, 12, 14,  0,  0,  0},
  { 0,  2,  4,  8, 12, 14,  0,  0},
  { 6,  8, 12, 14,  0,  0,  0,  0},
  { 0,  6,  8, 12, 14,  0,  0,  0},
  { 2,  6,  8, 12, 14,  0,  0,  0},
  { 0,  2,  6,  8, 12, 14,  0,  0},
  { 4,  6,  8, 12, 14,  0,  0,  0},
  { 0,  4,  6,  8, 12, 14,  0,  0},
  { 2,  4,  6,  8, 12, 14,  0,  0},
  { 0,  2,  4,  6,  8, 12, 14,  0},
  {10, 12, 14,  0,  0,  0,  0,  0},
  { 0, 10, 12, 14,  0,  0,  0,  0},
  { 2, 10, 12, 14,  0,  0,  0,  0},
  { 0,  2, 10, 12, 14,  0,  0,  0},
  { 4, 10, 12, 14,  0,  0,  0,  0},
  { 0,  4, 10, 12, 14,  0,  0,  0},
  { 2,  4, 10, 12, 14,  0,  0,  0},
  { 0,  2,  4, 10, 12, 14,  0,  0},
  { 6, 10, 12, 14,  0,  0,  0,  0},
  { 0,  6, 10, 12, 14,  0,  0,  0},
  { 2,  6, 10, 12, 14,  0,  0,  0},
  { 0,  2,  6, 10, 12, 14,  0,  0},
  { 4,  6, 10, 12, 14,  0,  0,  0},
  { 0,  4,  6, 10, 12, 14,  0,  0},
  { 2,  4,  6, 10, 12, 14,  0,  0},
  { 0,  2,  4,  6, 10, 12, 14,  0},
  { 8, 10, 12, 14,  0,  0,  0,  0},
  { 0,  8, 10, 12, 14,  0,  0,  0},
  { 2,  8, 10, 12, 14,  0,  0,  0},
  { 0,  2,  8, 10, 12, 14,  0,  0},
  { 4,  8, 10, 12, 14,  0,  0,  0},
  { 0,  4,  8, 10, 12, 14,  0,  0},
  { 2,  4,  8, 10, 12, 14,  0,  0},
  { 0,  2,  4,  8, 10, 12, 14,  0},
  { 6,  8, 10, 12, 14,  0,  0,  0},
  { 0,  6,  8, 10, 12, 14,  0,  0},
  { 2,  6,  8, 10, 12, 14,  0,  0},
  { 0,  2,  6,  8, 10, 12, 14,  0},
  { 4,  6,  8, 10, 12, 14,  0,  0},
  { 0,  4,  6,  8, 10, 12, 14,  0},
  { 2,  4,  6,  8, 10, 12, 14,  0},
  { 0,  2,  4,  6,  8, 10, 12, 14}
};

unsigned int rej_uniform(int16_t *r,
                         unsigned int len,
                         const unsigned char *buf,
                         unsigned int buflen)
{
  unsigned int ctr, pos;
  uint16_t vec[24];
  __m256i d, tmp, pi;
  __m128i pi0, pi1;
  uint32_t good;
  const __m256i bound = _mm256_set1_epi16(19*KYBER_Q - (1 << 15));
  const __m256i shift = _mm256_set1_epi16(-(1 << 15));
  const __m256i ones = _mm256_set1_epi8(1);

  ctr = pos = 0;
  while(ctr + 16 <= len && pos + 32 <= buflen) {
    d = _mm256_loadu_si256((__m256i *)buf+pos);
    d = _mm256_add_epi16(d, shift);
    tmp = _mm256_cmpgt_epi16(bound, d);
    good = _mm256_movemask_epi8(tmp);
    good = _pext_u32(good, 0x55555555);

    pi0 = _mm_loadl_epi64((__m128i *)&idx[good & 0xFF]);
    pi1 = _mm_loadl_epi64((__m128i *)&idx[(good >> 8) & 0xFF]);
    pi = _mm256_inserti128_si256(pi, pi0, 0);
    pi = _mm256_inserti128_si256(pi, pi1, 1);
    tmp = _mm256_add_epi8(pi, ones);
    pi = _mm256_unpacklo_epi8(pi, tmp);

    d = _mm256_shuffle_epi8(d, pi);
    _mm_storeu_si128((__m128i *)&r[ctr], _mm256_extracti128_si256(d, 0));
    ctr += __builtin_popcount(good & 0xFF);
    _mm_storeu_si128((__m128i *)&r[ctr], _mm256_extracti128_si256(d, 1));
    ctr += __builtin_popcount((good >> 8) & 0xFF);
    pos += 32;
  }

  while(ctr < len && pos + 2 <= buflen) {
    vec[0] = buf[pos+0] | ((uint16_t)buf[pos+1] << 8);
    pos += 2;

    if(vec[0] < 19*KYBER_Q)
      r[ctr++] = vec[0];
  }

  return ctr;
}
